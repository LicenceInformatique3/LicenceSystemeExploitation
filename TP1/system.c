#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "cpu.h"
#include "system.h"

/**********************************************************
** Demarrage du systeme
***********************************************************/

PSW systeme_init(void) {
	PSW cpu;

	printf("Booting.\n");
	/*** creation d'un programme ***/
	make_inst(0, INST_SUB, 0, 0, 0); 		/* R1 -= R1-0 */
	make_inst(1, INST_SUB, 1, 1, -1000); 	/* R2 = R2-(-1000) */
	make_inst(2, INST_SUB, 2, 2, -10);   	/* R3 = R3-(-10) */
	make_inst(3, INST_SUB, 3, 3, 0);   		/* R4 = R4+500 */
	make_inst(4, INST_CMP, 0, 1, 0);
	make_inst(5, INST_IFGT, 3, 0,11);
	make_inst(6, INST_NOP, 0, 0, 0);
	make_inst(7, INST_NOP, 0, 0, 0);
	make_inst(8, INST_NOP, 0, 0, 0);
	make_inst(9, INST_ADD, 0, 2, 0);   /* R1 += R3*/
	make_inst(10, INST_JUMP, 3, 0, 4);
	make_inst(11, INST_HALT, 0, 0, 0);
	
	/*** valeur initiale du PSW ***/
	memset (&cpu, 0, sizeof(cpu));
	cpu.PC = 0;
	cpu.SB = 0;
	cpu.SS = 20;

	return cpu;
}

void trace_Display(PSW m){
	switch (m.IN) {
		case INT_SEGV:
			printf("Address Error : INT_SEGV \n Interupt Number %d\n",m.IN);
			break;
		case INT_TRACE:
			printf("Trace Interupt : INT_TRACE \n Interupt Number %d\n",m.IN);
			break;
		case INT_INST:
			printf("Instruction Unknown : INT_INST \n Interupt Number %d\n",m.IN);
			break;
	}
}
	
PSW systeme_trace(PSW m) {
	trace_Display(m);
	printf("Program Counter : %d\n",m.PC);
	for(int i = 0; i < 8;i++){
		printf("Data Registers NÂ°%d : %d\n",i,m.DR[i]);
	}
	return m;
}

PSW systeme_sysc(PSW m){
	if(m.RI.ARG == SYSC_EXIT){
	
	}else if(m.RI.ARG == SYSC_PUTI){
		
	}
	trace_Display(m);
	return m;
} 

PSW systeme_exit(PSW m) {	
	trace_Display(m);
	exit(-1);
	return m;
}

/**********************************************************
** Simulation du systeme (mode systeme)
***********************************************************/

PSW systeme(PSW m) {
	switch (m.IN) {
		case INT_INIT:
			return (systeme_init());
		case INT_SEGV:
			return (systeme_exit(m));
		case INT_TRACE:
			return (systeme_trace(m));
		case INT_INST:
			return (systeme_exit(m));
		case INT_CLOCK:
			return (systeme_trace(m));
	}
	return m;
}
